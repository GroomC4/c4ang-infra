{{- if .Values.httpRoute.enabled }}
{{- range $serviceName, $serviceConfig := .Values.httpRoute.services }}
{{- if $serviceConfig.enabled }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $serviceName }}-service-route
  namespace: {{ include "istio.namespace" $ }}
  labels:
    {{- include "istio.labels" $ | nindent 4 }}
    service: {{ $serviceName }}
  {{- if $.Values.httpRoute.defaults.retry.enabled }}
  annotations:
    # VirtualService에서 마이그레이션한 retry 설정 (Istio 확장)
    retry.istio.io/attempts: {{ $.Values.httpRoute.defaults.retry.attempts | quote }}
    retry.istio.io/per-try-timeout: {{ $.Values.httpRoute.defaults.retry.perTryTimeout | quote }}
    retry.istio.io/retry-on: {{ $.Values.httpRoute.defaults.retry.retryOn | quote }}
  {{- end }}
spec:
  parentRefs:
    - name: {{ include "istio.gateway.main.name" $ }}
      sectionName: https
    {{- /* 추가 호스트네임 리스너에 명시적으로 연결 (k3d/CI 테스트용) */}}
    {{- if $.Values.gateway.main.additionalHostnames }}
    {{- range $idx, $hostname := $.Values.gateway.main.additionalHostnames }}
    - name: {{ include "istio.gateway.main.name" $ }}
      sectionName: http-{{ $hostname | replace "." "-" }}
    {{- end }}
    {{- end }}
  hostnames:
    - "{{ $.Values.gateway.main.hostname }}"
    {{- if $.Values.gateway.main.additionalHostnames }}
    {{- range $.Values.gateway.main.additionalHostnames }}
    - "{{ . }}"
    {{- end }}
    {{- end }}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: {{ $serviceConfig.path }}
      backendRefs:
        - name: {{ $serviceConfig.serviceName }}
          port: {{ $serviceConfig.servicePort }}
          weight: 100
      # VirtualService에서 마이그레이션한 timeout 설정 (Gateway API 표준)
      timeouts:
        request: {{ $.Values.httpRoute.defaults.timeout | default "30s" }}
{{- end }}
{{- end }}
{{- end }}

