apiVersion: v1
kind: ConfigMap
metadata:
  name: argo-rollouts-notification-configmap
  namespace: argo-rollouts
data:
  # ==========================================================================
  # ì„œë¹„ìŠ¤ ì„¤ì •
  # ==========================================================================

  {{- if .Values.notifications.grafana.enabled }}
  # Grafana ì•Œë¦¼ ì„¤ì •
  service.grafana: |
    address: http://a68126f1f9e17476aa603b145e3adfcb-394715272.ap-northeast-2.elb.amazonaws.com/login
    apiKey: $grafana-api-key
  {{- end }}

  {{- if .Values.notifications.discord.enabled }}
  # Discord Webhook ì„¤ì •
  service.webhook.discord: |
    url: https://discord.com/api/webhooks/1447770723887222855/H8QUSS2p9ZZrApzbhlsdFyjSuhFIjQUiNshZFRrnKUextrP9H2JYsl8arBLOjNmj8bBC
    headers:
    - name: Content-Type
      value: application/json

  # ==========================================================================
  # ì•Œë¦¼ í…œí”Œë¦¿ ì •ì˜ (Discord Embed í˜•ì‹ + ë§í¬ í¬í•¨)
  # ==========================================================================

  # ë°°í¬ ì„±ê³µ ì•Œë¦¼
  template.rollout-completed: |
    webhook:
      discord:
        method: POST
        body: |
          {"embeds":[{"title":"âœ… ë°°í¬ ì™„ë£Œ","color":3066993,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{`{{.rollout.metadata.name}}`}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{`{{.rollout.metadata.namespace}}`}}","inline":true},{"name":"ë²„ì „","value":"{{`{{.rollout.status.currentPodHash}}`}}","inline":true},{"name":"ğŸ”— ë§í¬","value":"[ArgoCD](https://argocd.c4ang.com/applications/argocd/{{`{{.rollout.metadata.name}}`}}) | [Grafana](https://grafana.c4ang.com/d/rollouts/argo-rollouts?var-rollout={{`{{.rollout.metadata.name}}`}})","inline":false}],"description":"Pre/Post Analysisë¥¼ í†µê³¼í•˜ì—¬ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."}]}

  # ìë™ ë¡¤ë°± ì•Œë¦¼ (ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•œ)
  template.rollout-aborted: |
    webhook:
      discord:
        method: POST
        body: |
          {"embeds":[{"title":"ğŸš¨ ìë™ ë¡¤ë°± ë°œìƒ","color":15158332,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{`{{.rollout.metadata.name}}`}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{`{{.rollout.metadata.namespace}}`}}","inline":true},{"name":"ì‚¬ìœ ","value":"{{`{{.rollout.status.message}}`}}","inline":false},{"name":"ğŸ“Š ì›ì¸ ë¶„ì„","value":"[Grafana ë©”íŠ¸ë¦­](https://grafana.c4ang.com/d/rollouts/argo-rollouts?var-rollout={{`{{.rollout.metadata.name}}`}}&var-namespace={{`{{.rollout.metadata.namespace}}`}})","inline":false},{"name":"ğŸ”— ìƒì„¸ í™•ì¸","value":"[ArgoCD](https://argocd.c4ang.com/applications/argocd/{{`{{.rollout.metadata.name}}`}}) | [Rollout ëŒ€ì‹œë³´ë“œ](https://rollouts.c4ang.com/rollout/{{`{{.rollout.metadata.namespace}}`}}/{{`{{.rollout.metadata.name}}`}})","inline":false}],"description":"PostPromotionAnalysis ì‹¤íŒ¨ë¡œ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ ë§í¬ì—ì„œ ì›ì¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”."}]}

  # ==========================================================================
  # íŠ¸ë¦¬ê±° ì •ì˜
  # ==========================================================================
  trigger.on-rollout-completed: |
    - send: [rollout-completed]
      when: rollout.status.phase == 'Healthy'

  trigger.on-rollout-aborted: |
    - send: [rollout-aborted]
      when: rollout.status.phase == 'Degraded'

  # ==========================================================================
  # ê¸°ë³¸ íŠ¸ë¦¬ê±° ë° êµ¬ë… ì„¤ì •
  # ==========================================================================
  defaultTriggers: |
    - on-rollout-completed
    - on-rollout-aborted

  subscriptions: |
    - recipients:
        - webhook:discord
      triggers:
        - on-rollout-completed
        - on-rollout-aborted
  {{- end }}