# [DEPRECATED] 이 파일은 레거시 방식입니다.
# 새로운 ApplicationSet 기반 방식을 사용하세요: argocd/applicationsets/
#
# 이 파일은 ArgoCD의 "App of Apps" 패턴을 구현하는 핵심 파일입니다.
# 클러스터에 배포되어야 할 모든 애플리케이션(인프라, 서비스)을 정의합니다.
#
# 마이그레이션 안내:
# 1. ApplicationSet 사용: argocd/applicationsets/*.yaml
# 2. 환경별 설정: config/local/*.yaml, config/prod/*.yaml
# 3. 차트 경로: charts/ (기존 helm/ -> charts/)

# 1. 인프라 애플리케이션: 모니터링
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-monitoring
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/monitoring  # 경로 업데이트: helm/management-base -> charts
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 2. 인프라 애플리케이션: Kafka
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-kafka-cluster
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/kafka-cluster  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 3. 인프라 애플리케이션: 데이터베이스 (PostgreSQL)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-database
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/statefulset-base/postgresql  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 4. Istio
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-istio
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/istio  # 경로 업데이트
    helm:
      parameters:
        - name: gateway.main.enabled
          value: "true"
        - name: gateway.main.name
          value: ecommerce-gateway
        - name: gateway.main.hostname
          value: api.ecommerce.com
        - name: security.mTLS.enabled
          value: "true"
        - name: security.mTLS.mode
          value: STRICT
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
---
# --- MSA 서비스 애플리케이션 ---
# 5. 서비스: Customer Service
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: service-customer
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/services/customer-service  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 6. 서비스: Store Service
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: service-store
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/services/store-service  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 7. 서비스: Payment Service
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: service-payment
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/services/payment-service  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 8. 서비스: Order Service
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: service-order
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/services/order-service  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
# 9. 서비스: Product Service
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: service-product
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/GroomC4/c4ang-infra.git
    targetRevision: main
    path: charts/services/product-service  # 경로 업데이트
  destination:
    server: https://kubernetes.default.svc
    namespace: ecommerce
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
