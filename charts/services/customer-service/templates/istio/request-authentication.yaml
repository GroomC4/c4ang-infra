{{- /*
  Service-level RequestAuthentication is DISABLED by default.
  JWT validation is now handled at the Gateway level only.

  Gateway에서 JWT 검증 후 X-User-Id, X-User-Role 헤더를 백엔드로 전달합니다.
  서비스는 이 헤더를 신뢰하고, 서비스 간 통신은 mTLS로 보호됩니다.

  이 파일은 호환성을 위해 유지되며, 필요시 istio.requestAuthentication.enabled: true로 활성화할 수 있습니다.
*/ -}}
{{- if and .Values.istio.enabled (.Values.istio.requestAuthentication).enabled }}
apiVersion: security.istio.io/v1
kind: RequestAuthentication
metadata:
  name: {{ include "customer-service.fullname" . }}-jwt-auth
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "customer-service.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      {{- include "customer-service.selectorLabels" . | nindent 6 }}
  jwtRules:
    - issuer: "ecommerce-service-api"
      jwksUri: "http://{{ include "customer-service.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.port }}/.well-known/jwks.json"
      forwardOriginalToken: true
      outputClaimToHeaders:
        - header: "X-User-Id"
          claim: "sub"
        - header: "X-User-Role"
          claim: "role"
        - header: "X-User-Email"
          claim: "email"
        - header: "X-User-Name"
          claim: "name"
{{- end }}