apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: post-promotion-analysis
  labels:
    {{- include "recommendation-service.labels" . | nindent 4 }}
spec:
  args:
    - name: service-name
    - name: namespace
      value: "ecommerce"
  metrics:
    # [전략 1: 가용성] Traffic Drop & Blackhole 감지
    # 이전(10분 전) 대비 트래픽이 50% 미만으로 떨어지면 롤백
    # 초기 지연 60초 (JVM 웜업 및 사이드카 초기화 시간 보장)
    - name: traffic-drop
      interval: 1m
      successCondition: result >= 0.5
      failureLimit: 1
      initialDelay: 60s
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              sum(rate(istio_requests_total{
                destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                reporter="source"
              }[1m]))
              /
              (
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m] offset 10m)) > 0
              )
            ) OR vector(1)

    # [전략 2: 정확도 보정 & 안정성] Minimum Traffic & Error Rate
    # 표본 부족(10 RPM 미만) 시 0 리턴(오탐 방지 - 분석 보류/통과), 에러율 임계치(5%) 초과 시 즉시 롤백
    - name: error-rate-safe
      interval: 30s
      successCondition: result < 0.05
      failureLimit: 1
      initialDelay: 60s
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              (
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source",
                  response_code=~"5.."
                }[1m]))
                /
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m]))
              )
              and
              (
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m])) * 60 >= 10
              )
            ) OR vector(0)

    # [전략 3: 기능] Business Metric (주문/로그인 성공)
    # 평소 대비 급격한 하락(30% 이상 하락) 시 롤백
    # 시스템은 정상이지만 로직 오류로 인한 장애 감지 (Netflix 사례)
    - name: business-success-check
      interval: 1m
      successCondition: result >= 0.7
      failureLimit: 1
      initialDelay: 60s
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              sum(rate(business_success_total{
                service="{{ "{{" }}args.service-name{{ "}}" }}"
              }[1m]))
              /
              (
                sum(rate(business_success_total{
                  service="{{ "{{" }}args.service-name{{ "}}" }}"
                }[1m] offset 10m)) > 0
              )
            ) OR vector(1)
