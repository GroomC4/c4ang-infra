# Argo Rollouts Helm Chart ì„¤ì •
# dependency chart (argo-rollouts)ì˜ ê°’ì€ 'argo-rollouts' í‚¤ ì•„ë˜ì— ì„¤ì •

namespace: argo-rollouts

argo-rollouts:
  # ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì •
  controller:
    replicas: 1
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false  # Prometheus Operator ì‚¬ìš© ì‹œ trueë¡œ ë³€ê²½

  # Dashboard ì„¤ì •
  dashboard:
    enabled: true
    service:
      type: ClusterIP
      port: 3100

  # CRD ì„¤ì¹˜ (í•„ìˆ˜)
  installCRDs: true

  # ì•Œë¦¼ ì„¤ì • - Notification Controller ë¹„í™œì„±í™”
  notifications:
    secret:
      create: false
    # webhook ì„œë¹„ìŠ¤ ì„¤ì • (ë¹„í™œì„±í™”)
    # notifiers:
    #   service.webhook.discord: |
    #     url: https://discord.com/api/webhooks/...
    #     headers:
    #     - name: Content-Type
    #       value: application/json
    # í…œí”Œë¦¿ ì •ì˜ - Discord Embed with Links
    templates:
      # ë°°í¬ ì„±ê³µ ì•Œë¦¼
      template.rollout-completed: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"âœ… ë°°í¬ ì™„ë£Œ","color":3066993,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{.rollout.status.currentPodHash}}","inline":true},{"name":"ğŸ”— ë§í¬","value":"[ArgoCD](https://argocd.c4ang.com/applications/argocd/{{.rollout.metadata.name}}) | [Grafana](https://grafana.c4ang.com/d/rollouts/argo-rollouts?var-rollout={{.rollout.metadata.name}})","inline":false}],"description":"Pre/Post Analysisë¥¼ í†µê³¼í•˜ì—¬ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."}]}
      # ìë™ ë¡¤ë°± ì•Œë¦¼ (ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•œ)
      template.rollout-aborted: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"ğŸš¨ ìë™ ë¡¤ë°± ë°œìƒ","color":15158332,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ì‚¬ìœ ","value":"{{.rollout.status.message}}","inline":false},{"name":"ğŸ“Š ì›ì¸ ë¶„ì„","value":"[Grafana ë©”íŠ¸ë¦­](https://grafana.c4ang.com/d/rollouts/argo-rollouts?var-rollout={{.rollout.metadata.name}}&var-namespace={{.rollout.metadata.namespace}})","inline":false},{"name":"ğŸ”— ìƒì„¸ í™•ì¸","value":"[ArgoCD](https://argocd.c4ang.com/applications/argocd/{{.rollout.metadata.name}}) | [Rollout ëŒ€ì‹œë³´ë“œ](https://rollouts.c4ang.com/rollout/{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}})","inline":false}],"description":"PostPromotionAnalysis ì‹¤íŒ¨ë¡œ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ ë§í¬ì—ì„œ ì›ì¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”."}]}
    # íŠ¸ë¦¬ê±° ì •ì˜
    triggers:
      trigger.on-rollout-completed: |
        - send: [rollout-completed]
          when: rollout.status.phase == 'Healthy'
      trigger.on-rollout-aborted: |
        - send: [rollout-aborted]
          when: rollout.status.phase == 'Degraded'

# ì¶”ê°€ ëª¨ë‹ˆí„°ë§ ì„¤ì • (ì»¤ìŠ¤í…€ ë¦¬ì†ŒìŠ¤)
metrics:
  enabled: true
  port: 8090
  targetPort: 8090

prometheus:
  enabled: true
  scrape: true
  path: /metrics
  port: 8090

# =============================================================================
# ì•Œë¦¼ ì„¤ì •
# =============================================================================
notifications:
  # Discord ì•Œë¦¼
  discord:
    enabled: false  # Discord ì•Œë¦¼ ë¹„í™œì„±í™”
    # Discord ì„œë²„ > ì„¤ì • > ì—°ë™ > ì›¹í›„í¬ì—ì„œ URL ìƒì„±
    # webhookUrlì€ Secretì—ì„œ ê´€ë¦¬ (argo-rollouts-notification-secret)

  # Grafana ì•Œë¦¼
  grafana:
    enabled: true
