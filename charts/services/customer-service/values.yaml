# Customer Service Helm Chart - 기본값
# 환경별 설정은 config/{env}/customer-service.yaml에서 관리
# 참고: docs/GITOPS-HELM-ARGOCD-GUIDE.md

fullnameOverride: customer-api

# 환경별로 오버라이드됨
replicaCount: 2

image:
  repository: ""  # config/{env}/customer-service.yaml에서 설정
  pullPolicy: IfNotPresent
  tag: ""         # config/{env}/customer-service.yaml에서 설정

imagePullSecrets: []

# 서비스 설정 (환경 무관)
service:
  type: ClusterIP
  port: 80
  targetPort: 8081

# 기본 리소스 (환경별로 오버라이드 가능)
resources:
  requests:
    memory: 512Mi
    cpu: 250m
  limits:
    memory: 1Gi
    cpu: 500m

# 오토스케일링 (환경별로 오버라이드 가능)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# 환경변수 - config/{env}/customer-service.yaml에서 정의
config:
  JWT_ACCESS_TOKEN_EXPIRATION_MINUTES: "4320"  # 3일 (테스트용)

# 시크릿 - config/{env}/customer-service.yaml에서 정의
secrets: {}

# 추가 환경변수
extraEnv: []

# Redis subchart (비활성화 - ExternalName 서비스 사용)
redis:
  enabled: false

# Istio 설정 (환경 무관한 공통 설정)
istio:
  enabled: true
  # Ambient 모드: sidecar 없이 ztunnel이 L4 mTLS 처리
  # config/dev/istio.yaml의 ambient.enabled와 동기화 필요
  ambient: false  # true면 sidecar injection 비활성화
  # Service-level RequestAuthentication은 비활성화 (Gateway에서 JWT 검증)
  requestAuthentication:
    enabled: false
  pathPrefix: /api/v1/customers
  timeout: 30s
  retries:
    attempts: 3
    perTryTimeout: 10s
    retryOn: "5xx,reset,connect-failure,refused-stream"
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 40
  gatewayAPI:
    enabled: true
    gatewayName: ecommerce-gateway
    gatewayNamespace: ecommerce
    hostnames:
      - api.c4ang.com

# Argo Rollouts 분석 설정
analysis:
  prometheusUrl: "http://prometheus.monitoring.svc.cluster.local:9090"

  # 분석 전략 활성화/비활성화
  strategies:
    trafficDrop:
      enabled: false  # 토이프로젝트 특성상 트래픽 적어 오탐 가능성 높음
    errorRate:
      enabled: true
    latency:
      enabled: true
    businessMetric:
      enabled: true
    webhookE2E:
      enabled: false  # 나중에 E2E 테스트 서버 준비되면 활성화

  # 임계값 설정 (환경별 오버라이드 가능)
  thresholds:
    # 트래픽 급감 감지: 이전 대비 이 비율 미만이면 롤백
    trafficDropRatio: 0.5
    # 에러율 임계치: 이 비율 초과 시 롤백
    errorRateLimit: 0.05
    # 최소 트래픽 (RPM): 이 미만이면 분석 스킵
    minTrafficRPM: 10
    # 비즈니스 메트릭 급감 비율
    businessSuccessRatio: 0.7
    # 레이턴시 임계값 (초)
    latencyP95Limit: 2.0
    latencyP99Limit: 5.0

  # 분석 주기 설정
  intervals:
    trafficDrop: "1m"
    errorRate: "30s"
    latency: "30s"
    businessMetric: "1m"

  # 초기 지연 (JVM 웜업 시간)
  initialDelay: "30s"

  # 분석 횟수 (30초 × 10회 = 5분 모니터링)
  analysisCount: 10

  # 실패 허용 횟수 (1회 실패 시 즉시 롤백 + 알림)
  failureLimit: 1

  # Webhook E2E 테스트 설정 (향후 사용)
  webhook:
    url: ""  # E2E 테스트 서버 URL (예: http://e2e-test-server.qa.svc.cluster.local/trigger)
    timeout: "5m"

# 알림 설정
notifications:
  discord:
    enabled: true  # Discord 알림 활성화
