{{- if and .Values.security.jwt.enabled .Values.security.authorizationPolicy.enabled }}
# ====================================
# Gateway Authorization Policies
# Role-based Access Control (경로 + 메서드 복합)
# ====================================

# Gateway selector 정의 (재사용)
{{- $gatewaySelector := dict "gateway.networking.k8s.io/gateway-name" (include "istio.gateway.main.name" .) }}

# ====================================
# 1. Public endpoints (인증 불필요)
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-public-endpoints
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # 인증 관련 엔드포인트
    {{- if .Values.security.publicEndpoints }}
    - to:
        - operation:
            paths:
              {{- range .Values.security.publicEndpoints }}
              - {{ . | quote }}
              {{- end }}
    {{- end }}
    # 헬스체크 및 모니터링
    - to:
        - operation:
            paths:
              - "/actuator/health"
              - "/actuator/health/*"
              - "/actuator/prometheus"
              - "/actuator/metrics"
              - "/actuator/info"
              - "/.well-known/*"
    # API 문서
    - to:
        - operation:
            paths:
              - "/swagger-ui/*"
              - "/v3/api-docs/*"
              - "/swagger-resources/*"
              - "/webjars/*"

---
# ====================================
# 2. CUSTOMER 전용 엔드포인트
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: customer-endpoints
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # 주문: CUSTOMER만 접근 가능
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/v1/orders"
              - "/api/v1/orders/*"
      when:
        - key: request.auth.claims[role]
          values: ["CUSTOMER"]
    # 결제: CUSTOMER만 접근 가능
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/v1/payments"
              - "/api/v1/payments/*"
      when:
        - key: request.auth.claims[role]
          values: ["CUSTOMER"]

---
# ====================================
# 3. OWNER 전용 엔드포인트 (CUD 작업)
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: owner-write-endpoints
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # 스토어 생성/수정/삭제: OWNER만
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/v1/stores"
              - "/api/v1/stores/*"
            methods: ["POST", "PUT", "PATCH", "DELETE"]
      when:
        - key: request.auth.claims[role]
          values: ["OWNER"]
    # 상품 생성/수정/삭제: OWNER만
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/v1/products"
              - "/api/v1/products/*"
            methods: ["POST", "PUT", "PATCH", "DELETE"]
      when:
        - key: request.auth.claims[role]
          values: ["OWNER"]

---
# ====================================
# 4. 조회는 모든 인증 사용자 허용
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: authenticated-read-endpoints
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # 스토어/상품 조회: 모든 인증 사용자
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/v1/stores"
              - "/api/v1/stores/*"
              - "/api/v1/products"
              - "/api/v1/products/*"
            methods: ["GET"]

---
# ====================================
# 5. Saga Tracker (백오피스용)
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: saga-tracker-endpoints
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # Saga 조회: OWNER만 (백오피스)
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/v1/sagas"
              - "/api/v1/sagas/*"
            methods: ["GET"]
      when:
        - key: request.auth.claims[role]
          values: ["OWNER"]

{{- end }}

---
# ====================================
# 6. 서비스 간 통신 (Service Mesh 내부)
# Gateway → 서비스, 서비스 → 서비스 모든 경로 허용
# ====================================
{{- if .Values.ambient.enabled }}
# Ambient 모드: ztunnel은 L4만 처리하므로 L7 AuthZ 불가
# Gateway 레벨 정책만 사용하고, 서비스간 통신은 mTLS로 보호
# 모든 트래픽 허용 (L4 레벨)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-mesh-internal
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  # 모든 워크로드에 적용
  action: ALLOW
  rules:
    # Ambient 모드: mTLS로 인증된 모든 트래픽 허용
    - {}
{{- else }}
# Sidecar 모드: L7 AuthZ 정책 사용 가능
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-mesh-internal
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  # 모든 워크로드에 적용 (selector 없음 = mesh 전체)
  action: ALLOW
  rules:
    # 같은 네임스페이스 내 서비스 간 모든 통신 허용
    - from:
        - source:
            principals:
              - "cluster.local/ns/{{ include "istio.namespace" . }}/sa/*"
{{- end }}

{{- if .Values.gateway.webhook.enabled }}
---
# ====================================
# Webhook Gateway Policy
# PG사, 파트너사 등 외부 시스템 콜백용
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: webhook-access
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: {{ include "istio.gateway.webhook.name" . }}
  action: ALLOW
  rules:
    {{- if .Values.security.webhook.ipWhitelist }}
    {{- range .Values.security.webhook.ipWhitelist }}
    - from:
        - source:
            remoteIpBlocks:
              - {{ . | quote }}
      to:
        - operation:
            paths:
              - "/webhooks/*"
            methods: ["POST"]
    {{- end }}
    {{- else }}
    # IP 화이트리스트가 설정되지 않은 경우 모든 IP 허용 (개발 환경)
    - to:
        - operation:
            paths:
              - "/webhooks/*"
            methods: ["POST"]
    {{- end }}
{{- end }}
