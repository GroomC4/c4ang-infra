{{- if .Values.gateway.main.enabled }}
# PreSync Hook: Gateway API CRD 설치
# Gateway 리소스를 생성하기 전에 CRD가 설치되어 있어야 합니다
apiVersion: batch/v1
kind: Job
metadata:
  name: install-gateway-api-crd
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "-5"
spec:
  ttlSecondsAfterFinished: 120
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: gateway-api-installer
      restartPolicy: Never
      containers:
      - name: install-crd
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "Checking if Gateway API CRDs are installed..."

          # Gateway CRD 존재 확인
          if kubectl get crd gateways.gateway.networking.k8s.io &>/dev/null; then
            echo "Gateway API CRDs already installed"
          else
            echo "Installing Gateway API CRDs..."
            kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/{{ .Values.crds.gatewayAPI.version | default "v1.2.0" }}/standard-install.yaml

            # CRD가 등록될 때까지 대기
            echo "Waiting for Gateway CRD to be established..."
            kubectl wait --for=condition=established crd/gateways.gateway.networking.k8s.io --timeout=60s
            kubectl wait --for=condition=established crd/httproutes.gateway.networking.k8s.io --timeout=60s
            kubectl wait --for=condition=established crd/gatewayclasses.gateway.networking.k8s.io --timeout=60s
          fi

          echo "Gateway API CRDs are ready!"
---
# ServiceAccount for the installer Job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gateway-api-installer
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "-6"
---
# ClusterRole for installing CRDs
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gateway-api-installer
  labels:
    {{- include "istio.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "-6"
rules:
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["gateway.networking.k8s.io"]
  resources: ["gatewayclasses"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gateway-api-installer
  labels:
    {{- include "istio.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "-6"
subjects:
- kind: ServiceAccount
  name: gateway-api-installer
  namespace: {{ include "istio.namespace" . }}
roleRef:
  kind: ClusterRole
  name: gateway-api-installer
  apiGroup: rbac.authorization.k8s.io
{{- end }}
