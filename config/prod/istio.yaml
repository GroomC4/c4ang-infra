# EKS 운영 환경 Istio Configuration
# ArgoCD ApplicationSet에서 사용

# Ambient Mesh 설정
# Sidecar 대신 ztunnel(L4)로 mTLS 자동 처리
ambient:
  enabled: true

# Namespace 설정
namespace:
  name: ecommerce
  create: false
  istioInjection: ambient  # enabled → ambient (sidecar 제거)

# Gateway 설정
gateway:
  main:
    enabled: true
    name: ecommerce-gateway
    hostname: api.ecommerce.com
    # AWS NLB 사용
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: external
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      cert-manager.io/cluster-issuer: letsencrypt-prod
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: ecommerce-tls-cert
              kind: Secret
      http:
        enabled: true
        port: 80
        redirectToHttps: true
    # ReferenceGrant 설정
    referenceGrant:
      enabled: true
      fromNamespaces:
        - order-service
        - payment-service
        - user-service

  webhook:
    enabled: true
    name: webhook-gateway
    hostname: webhook.ecommerce.com
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: external
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
      service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
      cert-manager.io/cluster-issuer: letsencrypt-prod
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: webhook-tls-cert
              kind: Secret

# Security 설정
security:
  mTLS:
    enabled: true
    mode: STRICT

  jwt:
    enabled: true
    issuer: "https://api.ecommerce.com"
    jwksUri: "https://api.ecommerce.com/.well-known/jwks.json"
    audiences:
      - "ecommerce-api"

  publicEndpoints:
    - /api/v1/users/register
    - /api/v1/users/login
    - /api/v1/users/refresh-token
    - /api/v1/auth/login
    - /api/v1/auth/refresh
    - /actuator/health
    - /actuator/prometheus

# HTTPRoute 설정
httpRoute:
  enabled: true
  services:
    order:
      enabled: true
      path: /api/v1/orders
      serviceName: order-api
      servicePort: 80
    product:
      enabled: true
      path: /api/v1/products
      serviceName: product-api
      servicePort: 80
    payment:
      enabled: true
      path: /api/v1/payments
      serviceName: payment-api
      servicePort: 80
    # PG사 콜백은 webhook gateway에서 처리 (webhookRoute 참조)
    auth:
      enabled: true
      path: /api/v1/auth
      serviceName: customer-api
      servicePort: 80
    store:
      enabled: true
      path: /api/v1/stores
      serviceName: store-api
      servicePort: 80
    saga-tracker:
      enabled: true
      path: /api/v1/sagas
      serviceName: saga-tracker-api
      servicePort: 80

# Telemetry 설정 (운영 환경)
telemetry:
  enabled: true
  samplingRate: 1.0  # 운영 환경에서도 전체 메트릭 수집 (필요시 조정)

# Webhook HTTPRoute 설정 (운영 환경)
# PG사 등 외부 콜백용 - IP 화이트리스트 적용 필요
webhookRoute:
  enabled: true
  routes:
    pg-callback:
      enabled: true
      path: /webhooks/pg/callback
      serviceName: payment-api
      servicePort: 80
      methods:
        - POST

# Rate Limit 설정
# TODO: 서비스 오픈 시 enabled: true로 변경
# 현재는 개발/테스트 단계이므로 비활성화
rateLimit:
  enabled: false  # 서비스 오픈 시 true로 변경
  # Global Rate Limit (전체 API)
  global:
    requestsPerSecond: 1000
    burst: 2000
  # Per-IP Rate Limit
  perIp:
    requestsPerSecond: 100
    burst: 200
  # Per-User Rate Limit (JWT subject 기반)
  perUser:
    requestsPerSecond: 50
    burst: 100
  # Endpoint별 Rate Limit
  endpoints:
    # 인증 관련 (무차별 대입 공격 방지)
    auth:
      path: "/api/v1/auth/*"
      requestsPerSecond: 10
      burst: 20
    # 주문 생성 (과도한 주문 방지)
    orders:
      path: "/api/v1/orders"
      methods: ["POST"]
      requestsPerSecond: 20
      burst: 50
    # 결제 (이중 결제 방지)
    payments:
      path: "/api/v1/payments"
      methods: ["POST"]
      requestsPerSecond: 10
      burst: 30

# Circuit Breaker 설정
# TODO: 서비스 고도화 단계에서 enabled: true로 변경
# 현재는 개발/테스트 단계이므로 비활성화
circuitBreaker:
  enabled: false  # 고도화 단계에서 true로 변경
  # Connection Pool 설정
  connectionPool:
    maxConnections: 100
    connectTimeout: 10s
    http1MaxPendingRequests: 100
    http2MaxRequests: 1000
    maxRequestsPerConnection: 10
    maxRetries: 3
  # Outlier Detection (Circuit Breaker 트리거)
  outlierDetection:
    consecutive5xxErrors: 5      # 연속 5회 5xx 에러 시 서킷 오픈
    consecutiveGatewayErrors: 5  # 게이트웨이 에러 포함
    consecutiveLocalOriginFailures: 5
    interval: 10s                # 에러 검사 간격
    baseEjectionTime: 30s        # 서킷 오픈 유지 시간
    maxEjectionPercent: 50       # 최대 50% 인스턴스 제외
    minHealthPercent: 30         # 최소 30% 정상 유지
