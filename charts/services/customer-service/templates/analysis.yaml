apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: blue-green-analysis
  labels:
    {{- include "customer-service.labels" . | nindent 4 }}
spec:
  args:
    - name: service-name
  metrics:
    # 1. 에러율 체크 (Istio 메트릭 활용)
    - name: error-rate
      count: 5
      interval: 30s
      successCondition: result < 0.05  # 5% 미만
      failureLimit: 3
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              sum(rate(istio_requests_total{
                destination_service_name=~"{{.Release.Name}}.*",
                destination_service_namespace="{{.Release.Namespace}}",
                response_code=~"5.."
              }[2m])) or vector(0)
            ) 
            / 
            (
              sum(rate(istio_requests_total{
                destination_service_name=~"{{.Release.Name}}.*",
                destination_service_namespace="{{.Release.Namespace}}"
              }[2m])) > 0 or vector(1)
            )

    # 2. 응답 시간 (p99 latency) - 밀리초 단위
    - name: latency-p99
      count: 5
      interval: 30s
      successCondition: result < 500  # 500ms 미만
      failureLimit: 3
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus.monitoring.svc.cluster.local:9090" }}
          query: |
            histogram_quantile(0.99,
              sum(rate(istio_request_duration_seconds_bucket{
                destination_service_name=~"{{.Release.Name}}.*",
                destination_service_namespace="{{.Release.Namespace}}"
              }[2m])) by (le)
            ) * 1000

    # 3. 성공률 체크
    - name: success-rate
      count: 5
      interval: 30s
      successCondition: result > 0.95  # 95% 이상
      failureLimit: 3
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              sum(rate(istio_requests_total{
                destination_service_name=~"{{.Release.Name}}.*",
                destination_service_namespace="{{.Release.Namespace}}",
                response_code!~"5.."
              }[2m])) or vector(0)
            ) 
            / 
            (
              sum(rate(istio_requests_total{
                destination_service_name=~"{{.Release.Name}}.*",
                destination_service_namespace="{{.Release.Namespace}}"
              }[2m])) > 0 or vector(1)
            )

    # 4. Pod 재시작 체크
    - name: pod-restart-check
      count: 5
      interval: 30s
      successCondition: result < 1
      failureLimit: 2
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus.monitoring.svc.cluster.local:9090" }}
          query: |
            sum(increase(kube_pod_container_status_restarts_total{
              namespace="{{.Release.Namespace}}",
              pod=~"{{.Release.Name}}-.*"
            }[5m])) or vector(0)