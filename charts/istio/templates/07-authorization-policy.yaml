{{- if and .Values.security.jwt.enabled .Values.security.authorizationPolicy.enabled }}
# ====================================
# Gateway Authorization Policies
# ALLOW-based pattern for better control
# ====================================

# 1. Allow public endpoints (no JWT required)
# 공개 엔드포인트 허용 (회원가입, 로그인, 헬스체크 등)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-public-endpoints
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      istio.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # Public API endpoints (authentication)
    {{- if .Values.security.publicEndpoints }}
    - to:
        - operation:
            paths:
              {{- range .Values.security.publicEndpoints }}
              - {{ . | quote }}
              {{- end }}
    {{- end }}
    # Health and monitoring endpoints
    - to:
        - operation:
            paths:
              - "/actuator/health"
              - "/actuator/health/*"
              - "/actuator/prometheus"
              - "/actuator/metrics"
              - "/actuator/info"
              - "/.well-known/*"
    # API Documentation
    - to:
        - operation:
            paths:
              - "/swagger-ui/*"
              - "/v3/api-docs/*"
              - "/swagger-resources/*"
              - "/webjars/*"
---
# 2. Allow protected API endpoints (JWT required)
# JWT가 있는 요청만 보호된 API 허용
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: require-jwt-for-api
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      istio.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: ALLOW
  rules:
    # Protected API endpoints - requires valid JWT
    - from:
        - source:
            requestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/*"
{{- end }}

{{- if .Values.gateway.webhook.enabled }}
---
# ====================================
# Webhook Gateway Policy
# PG사, 파트너사 등 외부 시스템 콜백용
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: webhook-access
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      istio.io/gateway-name: {{ include "istio.gateway.webhook.name" . }}
  action: ALLOW
  rules:
    {{- if .Values.security.webhook.ipWhitelist }}
    {{- range .Values.security.webhook.ipWhitelist }}
    - from:
        - source:
            remoteIpBlocks:
              - {{ . | quote }}
      to:
        - operation:
            paths:
              - "/webhooks/*"
            methods: ["POST"]
    {{- end }}
    {{- else }}
    # IP 화이트리스트가 설정되지 않은 경우 모든 IP 허용 (개발 환경)
    - to:
        - operation:
            paths:
              - "/webhooks/*"
            methods: ["POST"]
    {{- end }}
{{- end }}
