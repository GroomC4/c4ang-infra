# Istio Configuration Values
# 이 Helm 차트는 Istio 설정 리소스들(Gateway, HTTPRoute 등)을 관리합니다.
# Istio Control Plane은 별도로 istioctl로 설치해야 합니다.

# CRD 설치 설정
crds:
  install: false  # CRD는 Helm 차트 설치 전에 별도로 설치해야 합니다
  gatewayAPI:
    install: false
    version: "v1.0.0"  # Gateway API CRD 버전

# Namespace 설정
namespace:
  name: ecommerce
  create: true
  istioInjection: enabled  # Sidecar 자동 주입 활성화

# Gateway 설정
gateway:
  main:
    enabled: true
    name: ecommerce-gateway
    hostname: api.ecommerce.com
    # NLB 설정
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: ecommerce-tls-cert
              kind: Secret
      http:
        enabled: true
        port: 80
        redirectToHttps: true
  
  webhook:
    enabled: true
    name: webhook-gateway
    hostname: webhook.ecommerce.com
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: webhook-tls-cert
              kind: Secret

# Security 설정
security:
  mTLS:
    enabled: true
    mode: STRICT  # STRICT, PERMISSIVE, DISABLE
  
  jwt:
    enabled: true
    issuer: "https://api.ecommerce.com"
    jwksUri: "https://api.ecommerce.com/.well-known/jwks.json"
    audiences:
      - "ecommerce-api"
  
  # Webhook IP Whitelist (PG사, 파트너사 IP)
  webhook:
    ipWhitelist: []
      # - "203.0.113.0/24"  # PG사 IP 대역 (실제 IP로 변경 필요)
      # - "198.51.100.5/32"  # PG사 Backup IP (실제 IP로 변경 필요)
      # - "198.51.100.0/24"  # 파트너사 IP 대역 (실제 IP로 변경 필요)
  
  # Public endpoints (인증 불필요)
  publicEndpoints:
    - /api/v1/users/register
    - /api/v1/users/login
    - /api/v1/users/refresh-token
    - /api/v1/auth/login
    - /api/v1/auth/refresh
    - /actuator/health
    - /actuator/prometheus

  # 역할 기반 인가 (Authorization)
  authorization:
    enabled: true
    # JWT Claims 필드명
    roleClaim: "role"  # JWT에서 역할 정보가 담긴 claim 이름 (예: "role": "CUSTOMER")

    # 역할별 접근 가능한 API 경로 (템플릿 - 나중에 업데이트)
    paths:
      # CUSTOMER - 자신의 주문 내역만 조회
      customer:
        - /api/v1/orders/my/*        # 자신의 주문 조회
        - /api/v1/orders              # 주문 생성
        - /api/v1/stores              # 가게 목록 조회
        - /api/v1/products            # 상품 목록 조회
        # TODO: 실제 API 경로로 업데이트 필요

      # OWNER - 자신의 가게 주문, 가게 정보, 주문 처리, 메뉴 수정
      owner:
        - /api/v1/stores/my/*         # 자신의 가게 관리
        - /api/v1/orders/store/*      # 자신의 가게 주문 내역
        - /api/v1/products/store/*    # 자신의 가게 메뉴/상품 관리
        - /api/v1/orders/*/status     # 주문 상태 변경
        # TODO: 실제 API 경로로 업데이트 필요

      # MANAGER - 모든 가게 및 주문 관리 (MASTER 제외한 사용자 관리)
      manager:
        - /api/v1/stores/*            # 모든 가게 관리
        - /api/v1/orders/*            # 모든 주문 관리
        - /api/v1/products/*          # 모든 상품 관리
        - /api/v1/users/*             # 사용자 관리 (MASTER 제외)
        - /api/v1/analytics/*         # 분석 데이터
        # TODO: 실제 API 경로로 업데이트 필요
        # 단, /api/v1/managers/* 는 접근 불가 (MASTER만 가능)

# HTTPRoute 설정
httpRoute:
  enabled: true
  services:
    # 각 서비스별 라우팅 설정
    # 배포 시 자동으로 활성화
    order:
      enabled: true
      path: /api/v1/orders
      serviceName: order-service
      servicePort: 8080
    product:
      enabled: true
      path: /api/v1/products
      serviceName: product-service
      servicePort: 8080
    payment:
      enabled: true
      path: /api/v1/payments
      serviceName: payment-service
      servicePort: 8080
    user:
      enabled: true
      path: /api/v1/users
      serviceName: user-service
      servicePort: 8080
    auth:
      enabled: true
      path: /api/v1/auth
      serviceName: auth-service
      servicePort: 8080
    store:
      enabled: true
      path: /api/v1/stores
      serviceName: store-service
      servicePort: 8080
    review:
      enabled: true
      path: /api/v1/reviews
      serviceName: review-service
      servicePort: 8080
    recommendation:
      enabled: true
      path: /api/v1/recommendations
      serviceName: recommendation-service
      servicePort: 8080
    analytics:
      enabled: true
      path: /api/v1/analytics
      serviceName: analytics-service
      servicePort: 8080

# Traffic Management 설정
trafficManagement:
  destinationRules:
    enabled: true
    # Connection Pool 설정
    connectionPool:
      tcp:
        maxConnections: 50
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 100
        maxRequestsPerConnection: 1
        idleTimeout: 300s

    # Circuit Breaker 설정 (Outlier Detection)
    circuitBreaker:
      enabled: true
      consecutive5xxErrors: 5
      consecutiveGatewayErrors: 5
      interval: 5s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 40

    # Load Balancer 설정
    loadBalancer:
      simple: LEAST_REQUEST  # ROUND_ROBIN, LEAST_REQUEST, RANDOM, PASSTHROUGH

  virtualServices:
    enabled: true
    # 재시도 설정
    retries:
      attempts: 3
      perTryTimeout: 5s
      timeout: 5s

# EnvoyFilter 설정
envoyFilter:
  rateLimit:
    enabled: true
    customResponse: true  # 429 응답 커스터마이징
    limits:
      default: 100      # 기본: 초당 100건
      auth: 20          # 인증: 초당 20건
      orders: 50        # 주문: 초당 50건
      payments: 30      # 결제: 초당 30건
      products: 100     # 상품: 초당 100건

  tokenBlacklist:
    enabled: false
    redis:
      host: redis.ecommerce.svc.cluster.local
      port: 6379

# Gateway API CRD 설치
gatewayAPI:
  enabled: true
  version: "v1.0.0"

