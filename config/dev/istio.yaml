# Istio Configuration Values for k3d
# k3d 환경에 최적화된 Istio 설정
# Helm 차트: helm/management-base/istio

# Namespace 설정
namespace:
  name: ecommerce
  create: false  # install-istio.sh 스크립트가 생성

# Gateway 설정
gateway:
  main:
    enabled: true
    name: ecommerce-gateway
    hostname: api.ecommerce.com
    # k3d 환경에서는 LoadBalancer 타입이 NodePort로 매핑됨
    # AWS NLB 어노테이션은 k3d에서 무시됨
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      # k3d에서는 LoadBalancer가 자동으로 NodePort로 매핑됨
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: ecommerce-tls-cert
              kind: Secret
      http:
        enabled: true
        port: 80
        redirectToHttps: true
  
  webhook:
    enabled: true
    name: webhook-gateway
    hostname: webhook.ecommerce.com
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: webhook-tls-cert
              kind: Secret

# Security 설정
security:
  mTLS:
    enabled: true
    mode: STRICT
  
  jwt:
    enabled: true
    issuer: "https://api.ecommerce.com"
    jwksUri: "https://api.ecommerce.com/.well-known/jwks.json"
    audiences:
      - "ecommerce-api"
  
  # Public endpoints (인증 불필요)
  publicEndpoints:
    - /api/v1/users/register
    - /api/v1/users/login
    - /api/v1/users/refresh-token
    - /api/v1/auth/login
    - /api/v1/auth/refresh
    - /actuator/health
    - /actuator/prometheus

# HTTPRoute 설정
# 필요한 서비스만 활성화
httpRoute:
  enabled: true
  services:
    order:
      enabled: true
      path: /api/v1/orders
      serviceName: order-api
      servicePort: 80
    product:
      enabled: true
      path: /api/v1/products
      serviceName: product-api
      servicePort: 80
    payment:
      enabled: true
      path: /api/v1/payments
      serviceName: payment-api
      servicePort: 80
    # PG사 콜백은 webhook gateway에서 처리 (webhookRoute 참조)
    auth:
      enabled: true
      path: /api/v1/auth
      serviceName: customer-api
      servicePort: 80
    store:
      enabled: true
      path: /api/v1/stores
      serviceName: store-api
      servicePort: 80
    sagaTracker:
      enabled: true
      path: /api/v1/sagas
      serviceName: saga-tracker-api
      servicePort: 80

# Telemetry 설정 (k3d 환경)
telemetry:
  enabled: true
  samplingRate: 1.0  # 개발 환경이므로 모든 메트릭 수집

# Webhook HTTPRoute 설정 (개발 환경)
# 외부 시스템(PG사) 콜백용 - IP 화이트리스트 비활성화 상태 (개발용)
webhookRoute:
  enabled: true
  routes:
    pgCallback:
      enabled: true
      path: /webhooks/pg/callback
      serviceName: payment-api
      servicePort: 80
      methods:
        - POST

# Rate Limit 설정 (개발 환경)
# 개발 환경에서는 비활성화
# 서비스 오픈 시 prod 환경에서만 활성화
rateLimit:
  enabled: false

# Circuit Breaker 설정 (개발 환경)
# 개발 환경에서는 비활성화
# 고도화 단계에서 prod 환경에서만 활성화
circuitBreaker:
  enabled: false

