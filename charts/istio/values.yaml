# Istio Configuration Values
# 이 Helm 차트는 Istio 설정 리소스들(Gateway, HTTPRoute 등)을 관리합니다.
# Istio Control Plane은 별도로 istioctl로 설치해야 합니다.

# =============================================================================
# Ambient Mesh 설정
# =============================================================================
# Ambient 모드 활성화 시:
# - Sidecar injection 비활성화
# - ztunnel (DaemonSet)이 L4 mTLS 처리
# - L7 기능 필요시 waypoint proxy 배포
ambient:
  enabled: false  # true: Ambient 모드, false: Sidecar 모드
  waypoint:
    # L7 기능(JWT내부검증, L7 AuthZ, Retry 등) 필요시 배포
    enabled: false
    name: ecommerce-waypoint
    # 리소스 설정 (waypoint는 공유 프록시이므로 적절히 설정)
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

# CRD 설치 설정
crds:
  install: false  # CRD는 PreSync Hook으로 자동 설치됩니다
  gatewayAPI:
    install: true   # PreSync Hook에서 Gateway API CRD 설치
    version: "v1.2.0"  # Gateway API CRD 버전

# Namespace 설정
namespace:
  name: ecommerce
  create: true
  # Sidecar 모드: istio-injection=enabled
  # Ambient 모드: istio.io/dataplane-mode=ambient
  istioInjection: enabled  # ambient.enabled=true일 때 무시됨

# Gateway 설정
gateway:
  main:
    enabled: true
    name: ecommerce-gateway
    hostname: api.ecommerce.com
    # 추가 호스트네임 (로컬 개발, CI 테스트용)
    additionalHostnames:
      - "localhost"
    # NLB 설정
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: ecommerce-tls-cert
              kind: Secret
      http:
        enabled: true
        port: 80
        redirectToHttps: true
  
  webhook:
    enabled: true
    name: webhook-gateway
    hostname: webhook.ecommerce.com
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    listeners:
      https:
        enabled: true
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - name: webhook-tls-cert
              kind: Secret

# Security 설정
security:
  mTLS:
    enabled: true
    mode: STRICT  # STRICT, PERMISSIVE, DISABLE

  jwt:
    enabled: true
    # Customer Service가 발급한 JWT와 동일한 설정
    issuer: "ecommerce-service-api"
    # STRICT mTLS 환경에서는 istiod가 jwksUri를 fetch할 수 없으므로 inline jwks 사용
    # 키 로테이션 시 이 값도 업데이트 필요
    jwks: '{"keys":[{"kty":"RSA","e":"AQAB","use":"sig","kid":"ecommerce-key-1","alg":"RS256","n":"rw-UgxJKMS6oi4E3jW4y3tr6ZIAxBrRodZWDwfwAC3BBAtt7-hITIk8eNQwyMPV-qA_hv-xsGyqWvbMYb42LRgVLjD5lIV8EfTaNd5kV3nomnG57BUTFM6fYj_c9P7yUwhiDXEa2QOegem7gmw6v3dB-GHRPj8-_nDCLDBga6YN2DtptVw0Gg1rsX1y79Fn1Zr0XgL_oMkU-yjc87zHRnqg-3ojFmDpEan7zWPkqMeRHZUwePyUzllTtSVfH9iXBVnG_L8R94v_nGR9dbTou01nTORpc9uNp396RFin48rc39fvzoJFxTpvWvIvFIoAkvY83kaNMRWCt9vimL4Xx0Q"}]}'
    # Fallback: jwks가 없으면 jwksUri 사용 (PERMISSIVE mTLS 환경)
    jwksUri: "http://customer-api.ecommerce.svc.cluster.local:80/.well-known/jwks.json"
    audiences:
      - "ecommerce-api"

  # AuthorizationPolicy 설정 (jwt.enabled와 별개로 제어)
  # Gateway 레벨에서 Role 기반 접근 제어
  # - CUSTOMER: /api/v1/orders/*, /api/v1/payments/*
  # - OWNER: /api/v1/stores/*, /api/v1/products/* (CUD 작업)
  # - 인증된 사용자: 조회(GET) 허용
  authorizationPolicy:
    enabled: true
  
  # Webhook IP Whitelist (PG사, 파트너사 IP)
  webhook:
    ipWhitelist: []
      # - "203.0.113.0/24"  # PG사 IP 대역 (실제 IP로 변경 필요)
      # - "198.51.100.5/32"  # PG사 Backup IP (실제 IP로 변경 필요)
      # - "198.51.100.0/24"  # 파트너사 IP 대역 (실제 IP로 변경 필요)
  
  # Public endpoints (인증 불필요) - Prefix 매칭 사용
  publicEndpoints:
    # Customer/Owner Authentication (전체 auth 경로 허용)
    - /api/v1/auth/*
    # Legacy endpoints (if exists)
    - /api/v1/users/register
    - /api/v1/users/login
    - /api/v1/users/refresh-token
    # Health and Monitoring
    - /actuator/health
    - /actuator/health/*
    - /actuator/prometheus

# HTTPRoute 설정 (Main Gateway)
httpRoute:
  enabled: true
  services:
    # 각 서비스별 라우팅 설정
    # 실제 K8s 서비스명과 포트에 맞춤 (xxx-api:80)
    order:
      enabled: true
      path: /api/v1/orders
      serviceName: order-api
      servicePort: 80
    product:
      enabled: true
      path: /api/v1/products
      serviceName: product-api
      servicePort: 80
    payment:
      enabled: true
      path: /api/v1/payments
      serviceName: payment-api
      servicePort: 80
    auth:
      enabled: true
      path: /api/v1/auth
      serviceName: customer-api
      servicePort: 80
    store:
      enabled: true
      path: /api/v1/stores
      serviceName: store-api
      servicePort: 80
    saga-tracker:
      enabled: true
      path: /api/v1/sagas
      serviceName: saga-tracker-api
      servicePort: 80

# Traffic Management 설정
trafficManagement:
  destinationRules:
    enabled: true
    # Circuit Breaker 설정
    circuitBreaker:
      enabled: true
      consecutive5xxErrors: 5
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 40
  
  virtualServices:
    enabled: true
    # 재시도 설정
    retries:
      attempts: 3
      perTryTimeout: 5s
      timeout: 5s

# EnvoyFilter 설정
envoyFilter:
  rateLimit:
    enabled: true
    redis:
      host: redis.ecommerce.svc.cluster.local
      port: 6379
    limits:
      user: 100  # 초당 100 요청
      ip: 50     # 초당 50 요청
  
  tokenBlacklist:
    enabled: true
    redis:
      host: redis.ecommerce.svc.cluster.local
      port: 6379

# Gateway API CRD 설치
gatewayAPI:
  enabled: true
  version: "v1.0.0"

# Telemetry 설정 (Prometheus 메트릭)
telemetry:
  enabled: true
  # 메트릭 샘플링 비율 (0.0 ~ 1.0)
  # 1.0 = 모든 요청 메트릭 수집
  samplingRate: 1.0

# Webhook HTTPRoute 설정 (Webhook Gateway)
# 외부 시스템(PG사, 파트너사 등) 콜백용
# JWT 인증 없이 IP 화이트리스트 기반 접근 제어
webhookRoute:
  enabled: true
  routes:
    # PG사 결제 콜백
    pg-callback:
      enabled: true
      path: /webhooks/pg/callback
      serviceName: payment-api
      servicePort: 80
      methods:
        - POST
    # 파트너사 콜백 (확장용)
    # partnerCallback:
    #   enabled: false
    #   path: /webhooks/partner
    #   serviceName: partner-api
    #   servicePort: 80
    #   methods:
    #     - POST

