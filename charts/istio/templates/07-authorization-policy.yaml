{{- if and .Values.security.jwt.enabled .Values.security.authorizationPolicy.enabled }}
# ====================================
# Deny policy for protected API endpoints without JWT
# JWT가 없는 보호된 API 요청을 거부 (공개 엔드포인트 제외)
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: deny-api-without-jwt
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      istio.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  action: DENY
  rules:
    # JWT가 없는 요청 중 보호된 API 경로 거부
    - from:
        - source:
            notRequestPrincipals: ["*"]
      to:
        - operation:
            paths:
              - "/api/*"
            notPaths:
              {{- if .Values.security.publicEndpoints }}
              {{- range .Values.security.publicEndpoints }}
              - {{ . | quote }}
              {{- end }}
              {{- end }}
              # Health endpoints
              - "/actuator/health"
              - "/actuator/health/*"
              - "/actuator/prometheus"
              - "/actuator/metrics"
              - "/actuator/info"
              - "/.well-known/*"
              # API Documentation
              - "/swagger-ui/*"
              - "/v3/api-docs/*"
              - "/swagger-resources/*"
              - "/webjars/*"
{{- end }}

{{- if .Values.gateway.webhook.enabled }}
---
# ====================================
# Webhook Gateway Policy
# PG사, 파트너사 등 외부 시스템 콜백용
# ====================================
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: webhook-access
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      istio.io/gateway-name: {{ include "istio.gateway.webhook.name" . }}
  action: ALLOW
  rules:
    {{- if .Values.security.webhook.ipWhitelist }}
    {{- range .Values.security.webhook.ipWhitelist }}
    - from:
        - source:
            remoteIpBlocks:
              - {{ . | quote }}
      to:
        - operation:
            paths:
              - "/webhooks/*"
            methods: ["POST"]
    {{- end }}
    {{- else }}
    # IP 화이트리스트가 설정되지 않은 경우 모든 IP 허용 (개발 환경)
    - to:
        - operation:
            paths:
              - "/webhooks/*"
            methods: ["POST"]
    {{- end }}
{{- end }}
