{{- if .Values.rateLimit }}
{{- if .Values.rateLimit.enabled }}
# ====================================
# Rate Limit EnvoyFilter
# API Gateway에 Rate Limiting 적용
# TODO: 서비스 오픈 시 활성화 (rateLimit.enabled: true)
# ====================================
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: gateway-rate-limit
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  workloadSelector:
    labels:
      istio.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  configPatches:
    # HTTP Connection Manager에 Rate Limit 필터 추가
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            value:
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: {{ .Values.rateLimit.global.burst | default 2000 }}
                tokens_per_fill: {{ .Values.rateLimit.global.requestsPerSecond | default 1000 }}
                fill_interval: 1s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: "true"

---
# ====================================
# Per-IP Rate Limit using Descriptors
# 각 클라이언트 IP별 Rate Limiting
# ====================================
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: gateway-rate-limit-per-ip
  namespace: {{ include "istio.namespace" . }}
  labels:
    {{- include "istio.labels" . | nindent 4 }}
spec:
  workloadSelector:
    labels:
      istio.io/gateway-name: {{ include "istio.gateway.main.name" . }}
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: GATEWAY
      patch:
        operation: MERGE
        value:
          rate_limits:
            - actions:
                - remote_address: {}
              stage: 0

{{- end }}
{{- else }}
# ====================================
# Rate Limit 설정이 비활성화됨
# 서비스 오픈 시 config/prod/istio.yaml에서
# rateLimit.enabled: true 로 변경하여 활성화
#
# 권장 설정값:
# - Global: 1000 req/s (burst: 2000)
# - Per-IP: 100 req/s (burst: 200)
# - Per-User: 50 req/s (burst: 100)
# - Auth endpoints: 10 req/s (무차별 대입 공격 방지)
# - Orders POST: 20 req/s (과도한 주문 방지)
# - Payments POST: 10 req/s (이중 결제 방지)
# ====================================
{{- end }}
