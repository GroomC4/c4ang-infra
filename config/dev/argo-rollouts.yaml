# k3d ê°œë°œ í™˜ê²½ Argo Rollouts ì„¤ì •

namespace: argo-rollouts

argo-rollouts:
  controller:
    replicas: 1
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  dashboard:
    enabled: true
    service:
      type: ClusterIP
      port: 3100

  installCRDs: true

  notifications:
    secret:
      create: true
    # webhook ì„œë¹„ìŠ¤ ì„¤ì •
    notifiers:
      service.webhook.discord: |
        url: https://discord.com/api/webhooks/1447770723887222855/H8QUSS2p9ZZrApzbhlsdFyjSuhFIjQUiNshZFRrnKUextrP9H2JYsl8arBLOjNmj8bBC
        headers:
        - name: Content-Type
          value: application/json
    # =======================================================================
    # í…œí”Œë¦¿ ì •ì˜ - Discord Embed
    # ë²„ì „ í˜•ì‹: v1.2.3(abc1234) - ì´ë¯¸ì§€ íƒœê·¸ + Pod Hash
    # =======================================================================
    templates:
      # ----- Pre-Promotion Analysis -----
      template.pre-analysis-running: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"ğŸ” Pre-Analysis ì‹œì‘","color":3447003,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true}],"description":"Preview í™˜ê²½ì—ì„œ Smoke Testë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.","timestamp":"{{ .rollout.metadata.creationTimestamp }}"}]}
      template.pre-analysis-success: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"âœ… Pre-Analysis ì„±ê³µ","color":3066993,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true}],"description":"Smoke Test í†µê³¼! Blue-Green ì „í™˜ì„ ì§„í–‰í•©ë‹ˆë‹¤."}]}
      template.pre-analysis-failed: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"âŒ Pre-Analysis ì‹¤íŒ¨","color":15158332,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true},{"name":"ì‚¬ìœ ","value":"{{.rollout.status.message}}","inline":false}],"description":"Smoke Test ì‹¤íŒ¨ë¡œ ë°°í¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. Preview í™˜ê²½ì„ í™•ì¸í•´ì£¼ì„¸ìš”."}]}
      # ----- Blue-Green ì „í™˜ -----
      template.rollout-switch: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"ğŸ”„ Blue-Green ì „í™˜","color":7506394,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true}],"description":"Active ì„œë¹„ìŠ¤ê°€ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. Post-Analysisë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."}]}
      # ----- Post-Promotion Analysis -----
      template.post-analysis-running: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"ğŸ“Š Post-Analysis ì‹œì‘","color":3447003,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true}],"description":"ì‹¤ì œ íŠ¸ë˜í”½ ê¸°ë°˜ìœ¼ë¡œ Error Rate, Latencyë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤."}]}
      template.post-analysis-success: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"âœ… Post-Analysis ì„±ê³µ","color":3066993,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true}],"description":"í”„ë¡œë•ì…˜ íŠ¸ë˜í”½ ê²€ì¦ ì™„ë£Œ! ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."}]}
      template.post-analysis-failed: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"ğŸš¨ Post-Analysis ì‹¤íŒ¨","color":15158332,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true},{"name":"ì‚¬ìœ ","value":"{{.rollout.status.message}}","inline":false}],"description":"í”„ë¡œë•ì…˜ íŠ¸ë˜í”½ ê²€ì¦ ì‹¤íŒ¨! ìë™ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."}]}
      # ----- ìµœì¢… ìƒíƒœ -----
      template.rollout-completed: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"ğŸ‰ ë°°í¬ ì™„ë£Œ","color":3066993,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true}],"description":"Pre/Post Analysisë¥¼ ëª¨ë‘ í†µê³¼í•˜ì—¬ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."}]}
      template.rollout-aborted: |
        webhook:
          discord:
            method: POST
            body: |
              {"embeds":[{"title":"â›” ë°°í¬ ì¤‘ë‹¨ (ë¡¤ë°± ì™„ë£Œ)","color":15158332,"fields":[{"name":"ì„œë¹„ìŠ¤","value":"{{.rollout.metadata.name}}","inline":true},{"name":"ë„¤ì„ìŠ¤í˜ì´ìŠ¤","value":"{{.rollout.metadata.namespace}}","inline":true},{"name":"ë²„ì „","value":"{{ (index .rollout.spec.template.spec.containers 0).image | splitList \":\" | last }}({{.rollout.status.currentPodHash}})","inline":true},{"name":"ì‚¬ìœ ","value":"{{.rollout.status.message}}","inline":false}],"description":"Analysis ì‹¤íŒ¨ë¡œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤."}]}
    # =======================================================================
    # íŠ¸ë¦¬ê±° ì •ì˜
    # =======================================================================
    triggers:
      # Pre-Promotion Analysis
      trigger.on-pre-analysis-running: |
        - send: [pre-analysis-running]
          when: rollout.status.blueGreen.prePromotionAnalysisRunStatus.status == 'Running'
      trigger.on-pre-analysis-success: |
        - send: [pre-analysis-success]
          when: rollout.status.blueGreen.prePromotionAnalysisRunStatus.status == 'Successful'
      trigger.on-pre-analysis-failed: |
        - send: [pre-analysis-failed]
          when: rollout.status.blueGreen.prePromotionAnalysisRunStatus.status == 'Failed'
      # Blue-Green ì „í™˜ (Active ì„œë¹„ìŠ¤ ë³€ê²½)
      trigger.on-rollout-switch: |
        - send: [rollout-switch]
          when: rollout.status.blueGreen.activeSelector != rollout.status.blueGreen.previousActiveSelector
      # Post-Promotion Analysis
      trigger.on-post-analysis-running: |
        - send: [post-analysis-running]
          when: rollout.status.blueGreen.postPromotionAnalysisRunStatus.status == 'Running'
      trigger.on-post-analysis-success: |
        - send: [post-analysis-success]
          when: rollout.status.blueGreen.postPromotionAnalysisRunStatus.status == 'Successful'
      trigger.on-post-analysis-failed: |
        - send: [post-analysis-failed]
          when: rollout.status.blueGreen.postPromotionAnalysisRunStatus.status == 'Failed'
      # ìµœì¢… ìƒíƒœ
      trigger.on-rollout-completed: |
        - send: [rollout-completed]
          when: rollout.status.phase == 'Healthy'
      trigger.on-rollout-aborted: |
        - send: [rollout-aborted]
          when: rollout.status.phase == 'Degraded'

# ê°œë°œ í™˜ê²½ ëª¨ë‹ˆí„°ë§ ì„¤ì •
metrics:
  enabled: true
  port: 8090
  targetPort: 8090

prometheus:
  enabled: true
  scrape: true
  path: /metrics
  port: 8090
