apiVersion: v1
kind: ConfigMap
metadata:
  name: argo-rollouts-notification-configmap
  namespace: argo-rollouts
data:
  # Grafana ì•Œë¦¼ ì„¤ì •
  service.grafana: |
    address: http://a68126f1f9e17476aa603b145e3adfcb-394715272.ap-northeast-2.elb.amazonaws.com/login
    api-key: $grafana-api-key

  # Discord Webhook ì„¤ì •
  # Secretì— discord-webhook-url í‚¤ë¡œ Webhook URL ì €ì¥ í•„ìš”
  # Discord ì„œë²„ ì„¤ì • > ì—°ë™ > ì›¹í›„í¬ì—ì„œ ìƒì„±
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
      - name: Content-Type
        value: application/json

  # ==========================================================================
  # ì•Œë¦¼ í…œí”Œë¦¿ ì •ì˜ (Discord Embed í˜•ì‹)
  # ==========================================================================

  # ë¶„ì„ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ (ìˆ˜ë™ ê²°ì • ìš”ì²­)
  template.analysis-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "âš ï¸ ë°°í¬ ë¶„ì„ ì‹¤íŒ¨ - ê²€í†  í•„ìš”",
              "color": 14495300,
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "{{.rollout.metadata.name}}", "inline": true},
                {"name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤", "value": "{{.rollout.metadata.namespace}}", "inline": true},
                {"name": "ìƒíƒœ", "value": "{{.rollout.status.phase}}", "inline": true},
                {"name": "ë©”ì‹œì§€", "value": "{{.rollout.status.message}}", "inline": false}
              ],
              "description": "ë¶„ì„ ê²°ê³¼ì— ë”°ë¼ ë°°í¬ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n**ìˆ˜ë™ìœ¼ë¡œ ìŠ¹ê²© ë˜ëŠ” ë¡¤ë°±ì„ ê²°ì •í•´ì£¼ì„¸ìš”.**\n\n[ArgoCDì—ì„œ í™•ì¸](https://argocd.c4ang.com/applications/{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}})",
              "timestamp": "{{.rollout.status.pauseConditions | first | default dict | dig \"startTime\" time.Now | date \"2006-01-02T15:04:05Z07:00\"}}"
            }]
          }

  # ë°°í¬ ì„±ê³µ ì•Œë¦¼
  template.rollout-completed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "âœ… ë°°í¬ ì™„ë£Œ",
              "color": 3066993,
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "{{.rollout.metadata.name}}", "inline": true},
                {"name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤", "value": "{{.rollout.metadata.namespace}}", "inline": true},
                {"name": "ë²„ì „", "value": "{{.rollout.status.currentPodHash}}", "inline": true}
              ],
              "timestamp": "{{time.Now | date \"2006-01-02T15:04:05Z07:00\"}}"
            }]
          }

  # ë¡¤ë°± ë°œìƒ ì•Œë¦¼
  template.rollout-aborted: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "ğŸ”„ ë°°í¬ ë¡¤ë°± ë°œìƒ",
              "color": 14495300,
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "{{.rollout.metadata.name}}", "inline": true},
                {"name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤", "value": "{{.rollout.metadata.namespace}}", "inline": true},
                {"name": "ì‚¬ìœ ", "value": "{{.rollout.status.message}}", "inline": false}
              ],
              "timestamp": "{{time.Now | date \"2006-01-02T15:04:05Z07:00\"}}"
            }]
          }

  # ë¶„ì„ ì‹œì‘ ì•Œë¦¼ (ì„ íƒì )
  template.analysis-started: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "ğŸ” ë°°í¬ ë¶„ì„ ì‹œì‘",
              "color": 3447003,
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "{{.rollout.metadata.name}}", "inline": true},
                {"name": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤", "value": "{{.rollout.metadata.namespace}}", "inline": true}
              ],
              "description": "Pre/Post Promotion ë¶„ì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.",
              "timestamp": "{{time.Now | date \"2006-01-02T15:04:05Z07:00\"}}"
            }]
          }

  # ==========================================================================
  # íŠ¸ë¦¬ê±° ì •ì˜
  # ==========================================================================
  trigger.on-analysis-run-failed: |
    - send: [analysis-failed]
      when: analysis.phase == 'Failed'

  trigger.on-rollout-completed: |
    - send: [rollout-completed]
      when: rollout.status.phase == 'Healthy'

  trigger.on-rollout-aborted: |
    - send: [rollout-aborted]
      when: rollout.status.phase == 'Degraded'

  trigger.on-analysis-run-running: |
    - send: [analysis-started]
      when: analysis.phase == 'Running'

  # ==========================================================================
  # ê¸°ë³¸ íŠ¸ë¦¬ê±° ë° êµ¬ë… ì„¤ì •
  # ==========================================================================
  defaultTriggers: |
    - on-analysis-run-failed
    - on-rollout-completed
    - on-rollout-aborted

  subscriptions: |
    - recipients:
        - webhook:discord
      triggers:
        - on-analysis-run-failed
        - on-rollout-completed
        - on-rollout-aborted
        - on-analysis-run-running