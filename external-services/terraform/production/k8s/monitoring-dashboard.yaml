---
# Prometheus Operator ÏÑ§Ïπò (Í∞ÑÎã®Ìïú Î≤ÑÏ†Ñ)
# Ï∞∏Í≥†: ÌîÑÎ°úÎçïÏÖòÏóêÏÑúÎäî HelmÏùÑ ÏÇ¨Ïö©ÌïòÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
# Í∞ÑÎã®Ìïú Î™®ÎãàÌÑ∞ÎßÅÏùÑ ÏúÑÌïú ServiceMonitor (PrometheusÍ∞Ä ÏûàÎäî Í≤ΩÏö∞)
# Ïã§Ï†úÎ°úÎäî Prometheus OperatorÎ•º ÏÑ§ÏπòÌï¥Ïïº Ìï©ÎãàÎã§
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitoring-config
  namespace: monitoring
data:
  dashboard.json: |
    {
      "dashboard": {
        "title": "Kafka HPA Monitoring",
        "panels": [
          {
            "title": "Pod Count",
            "targets": [
              {
                "expr": "count(kube_pod_info{namespace=\"kafka\", pod=~\"kafka-consumer.*\"})"
              }
            ]
          },
          {
            "title": "CPU Usage",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"kafka\", pod=~\"kafka-consumer.*\"}[5m]))"
              }
            ]
          }
        ]
      }
    }
---
# Í∞ÑÎã®Ìïú Î™®ÎãàÌÑ∞ÎßÅ Ïä§ÌÅ¨Î¶ΩÌä∏Ïö© ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitoring-scripts
  namespace: kafka
data:
  monitor-hpa.sh: |
    #!/bin/bash
    while true; do
      clear
      echo "=== Kafka Consumer HPA Monitoring ==="
      echo ""
      echo "üìä HPA Status:"
      kubectl get hpa -n kafka kafka-consumer-hpa
      echo ""
      echo "üì¶ Pod Status:"
      kubectl get pods -n kafka -l app=kafka-consumer -o wide
      echo ""
      echo "üíª CPU/Memory Usage:"
      kubectl top pods -n kafka -l app=kafka-consumer 2>/dev/null || echo "Metrics Server not available"
      echo ""
      echo "üìà Consumer Group Lag:"
      POD_NAME=$(kubectl get pods -n kafka -l app=kafka-client --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
      if [ -n "$POD_NAME" ]; then
        MSK_BROKERS=$(kubectl get secret -n kafka msk-bootstrap-brokers -o jsonpath='{.data.bootstrap-brokers}' | base64 -d)
        kubectl exec -n kafka $POD_NAME -- kafka-consumer-groups \
          --bootstrap-server $MSK_BROKERS \
          --describe \
          --group hpa-test-consumer-group 2>/dev/null | grep -E "TOPIC|LAG|CURRENT-OFFSET" || echo "Consumer Group not found"
      fi
      echo ""
      echo "‚è∞ Updated: $(date '+%Y-%m-%d %H:%M:%S')"
      sleep 5
    done
  monitor-kafka.sh: |
    #!/bin/bash
    POD_NAME=$(kubectl get pods -n kafka -l app=kafka-client --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}')
    MSK_BROKERS=$(kubectl get secret -n kafka msk-bootstrap-brokers -o jsonpath='{.data.bootstrap-brokers}' | base64 -d)
    
    echo "=== Kafka Topic Status ==="
    kubectl exec -n kafka $POD_NAME -- kafka-topics --bootstrap-server $MSK_BROKERS --list
    echo ""
    echo "=== Consumer Groups ==="
    kubectl exec -n kafka $POD_NAME -- kafka-consumer-groups --bootstrap-server $MSK_BROKERS --list
    echo ""
    echo "=== Consumer Group Details ==="
    kubectl exec -n kafka $POD_NAME -- kafka-consumer-groups \
      --bootstrap-server $MSK_BROKERS \
      --describe \
      --group hpa-test-consumer-group

