# =============================================================================
# Argo Rollouts AnalysisTemplate - Post-Promotion Analysis
# =============================================================================
# 배포 승격(Green 전환) 후 실행되는 분석 템플릿
# 실제 프로덕션 트래픽을 기반으로 서비스 상태를 모니터링
#
# 검증 항목:
#   - Error Rate: 5xx 에러 비율 모니터링
#   - Latency: P95/P99 응답 시간 모니터링
#   - Business Metrics: 비즈니스 성공률 모니터링 (선택적)
#
# 분석 실패 시: 자동 롤백 + Discord 알림
#
# 각 전략은 values.yaml의 analysis.strategies에서 활성화/비활성화 가능
# 임계값은 values.yaml의 analysis.thresholds에서 환경별 조정 가능

apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: post-promotion-analysis
  labels:
    {{- include "customer-service.labels" . | nindent 4 }}
spec:
  args:
    - name: service-name
    - name: namespace
      value: "ecommerce"
  metrics:
    # =========================================================================
    # [전략 1: 가용성] Traffic Drop & Blackhole 감지
    # =========================================================================
    # 이전(10분 전) 대비 트래픽이 임계값 미만으로 떨어지면 롤백
    # 초기 지연: JVM 웜업 및 사이드카 초기화 시간 보장
    {{- if .Values.analysis.strategies.trafficDrop.enabled }}
    - name: traffic-drop
      interval: {{ .Values.analysis.intervals.trafficDrop | default "1m" }}
      count: {{ .Values.analysis.analysisCount | default 5 }}
      successCondition: result >= {{ .Values.analysis.thresholds.trafficDropRatio | default 0.5 }}
      failureLimit: {{ .Values.analysis.failureLimit | default 1 }}
      initialDelay: {{ .Values.analysis.initialDelay | default "60s" }}
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              sum(rate(istio_requests_total{
                destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                reporter="source"
              }[1m]))
              /
              (
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m] offset 10m)) > 0
              )
            ) OR vector(1)
    {{- end }}

    # =========================================================================
    # [전략 2: 정확도 보정 & 안정성] Minimum Traffic & Error Rate
    # =========================================================================
    # 표본 부족(최소 RPM 미만) 시 0 리턴(오탐 방지 - 분석 보류/통과)
    # 에러율 임계치 초과 시 즉시 롤백
    {{- if .Values.analysis.strategies.errorRate.enabled }}
    - name: error-rate-safe
      interval: {{ .Values.analysis.intervals.errorRate | default "30s" }}
      count: {{ mul .Values.analysis.analysisCount 2 | default 10 }}
      successCondition: result < {{ .Values.analysis.thresholds.errorRateLimit | default 0.05 }}
      failureLimit: {{ .Values.analysis.failureLimit | default 1 }}
      initialDelay: {{ .Values.analysis.initialDelay | default "60s" }}
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              (
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source",
                  response_code=~"5.."
                }[1m]))
                /
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m]))
              )
              and
              (
                sum(rate(istio_requests_total{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m])) * 60 >= {{ .Values.analysis.thresholds.minTrafficRPM | default 10 }}
              )
            ) OR vector(0)
    {{- end }}

    # =========================================================================
    # [전략 3: 성능] Latency P95 분석
    # =========================================================================
    # P95 응답시간이 임계값을 초과하면 롤백
    # 느려진 서비스는 사용자 경험에 직접적인 영향
    {{- if .Values.analysis.strategies.latency.enabled }}
    - name: latency-p95
      interval: {{ .Values.analysis.intervals.latency | default "30s" }}
      count: {{ mul .Values.analysis.analysisCount 2 | default 10 }}
      successCondition: result <= {{ .Values.analysis.thresholds.latencyP95Limit | default 2.0 }}
      failureLimit: {{ .Values.analysis.failureLimit | default 1 }}
      initialDelay: {{ .Values.analysis.initialDelay | default "60s" }}
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              histogram_quantile(0.95,
                sum(rate(istio_request_duration_milliseconds_bucket{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m])) by (le)
              ) / 1000
            )
            and
            (
              sum(rate(istio_requests_total{
                destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                reporter="source"
              }[1m])) * 60 >= {{ .Values.analysis.thresholds.minTrafficRPM | default 10 }}
            )
            OR vector(0)

    # =========================================================================
    # [전략 4: 성능] Latency P99 분석
    # =========================================================================
    # P99 응답시간 (tail latency) 모니터링
    # 일부 사용자의 극단적으로 느린 경험 감지
    - name: latency-p99
      interval: {{ .Values.analysis.intervals.latency | default "30s" }}
      count: {{ mul .Values.analysis.analysisCount 2 | default 10 }}
      successCondition: result <= {{ .Values.analysis.thresholds.latencyP99Limit | default 5.0 }}
      failureLimit: {{ .Values.analysis.failureLimit | default 1 }}
      initialDelay: {{ .Values.analysis.initialDelay | default "60s" }}
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              histogram_quantile(0.99,
                sum(rate(istio_request_duration_milliseconds_bucket{
                  destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                  reporter="source"
                }[1m])) by (le)
              ) / 1000
            )
            and
            (
              sum(rate(istio_requests_total{
                destination_service=~"{{ "{{" }}args.service-name{{ "}}" }}.*",
                reporter="source"
              }[1m])) * 60 >= {{ .Values.analysis.thresholds.minTrafficRPM | default 10 }}
            )
            OR vector(0)
    {{- end }}

    # =========================================================================
    # [전략 5: 기능] Business Metric (주문/로그인 성공)
    # =========================================================================
    # 평소 대비 급격한 하락(임계값 이상 하락) 시 롤백
    # 시스템은 정상이지만 로직 오류로 인한 장애 감지 (Netflix 사례)
    {{- if .Values.analysis.strategies.businessMetric.enabled }}
    - name: business-success-check
      interval: {{ .Values.analysis.intervals.businessMetric | default "1m" }}
      count: {{ .Values.analysis.analysisCount | default 5 }}
      successCondition: result >= {{ .Values.analysis.thresholds.businessSuccessRatio | default 0.7 }}
      failureLimit: {{ .Values.analysis.failureLimit | default 1 }}
      initialDelay: {{ .Values.analysis.initialDelay | default "60s" }}
      provider:
        prometheus:
          address: {{ .Values.analysis.prometheusUrl | default "http://prometheus-server.monitoring.svc.cluster.local:9090" }}
          query: |
            (
              sum(rate(business_success_total{
                service="{{ "{{" }}args.service-name{{ "}}" }}"
              }[1m]))
              /
              (
                sum(rate(business_success_total{
                  service="{{ "{{" }}args.service-name{{ "}}" }}"
                }[1m] offset 10m)) > 0
              )
            ) OR vector(1)
    {{- end }}

# =============================================================================
# [향후 구현] Webhook E2E Test AnalysisTemplate
# =============================================================================
# E2E 테스트 서버가 준비되면 아래 템플릿 활성화
# 외부 테스트 서버를 호출하여 시나리오 기반 검증 수행
#
# 사용법:
# 1. E2E 테스트 서버 준비 (예: Playwright/Cypress 기반)
# 2. values.yaml에서 analysis.strategies.webhookE2E.enabled: true
# 3. values.yaml에서 analysis.webhook.url 설정
#
# {{- if .Values.analysis.strategies.webhookE2E.enabled }}
# ---
# apiVersion: argoproj.io/v1alpha1
# kind: AnalysisTemplate
# metadata:
#   name: e2e-test-analysis
#   labels:
#     {{- include "customer-service.labels" . | nindent 4 }}
# spec:
#   args:
#     - name: service-name
#     - name: namespace
#       value: "ecommerce"
#     - name: version
#   metrics:
#     - name: e2e-scenario-test
#       # E2E 테스트는 시간이 오래 걸릴 수 있으므로 단일 실행
#       count: 1
#       failureLimit: 0
#       provider:
#         web:
#           url: "{{ .Values.analysis.webhook.url }}?service={{ "{{" }}args.service-name{{ "}}" }}&version={{ "{{" }}args.version{{ "}}" }}&namespace={{ "{{" }}args.namespace{{ "}}" }}"
#           method: POST
#           headers:
#             - key: Content-Type
#               value: application/json
#           body: |
#             {
#               "service": "{{ "{{" }}args.service-name{{ "}}" }}",
#               "namespace": "{{ "{{" }}args.namespace{{ "}}" }}",
#               "version": "{{ "{{" }}args.version{{ "}}" }}",
#               "scenarios": ["login", "profile_update", "token_refresh"]
#             }
#           # E2E 서버는 {"status": "success"} 또는 {"status": "failure"} 반환
#           jsonPath: "{$.status}"
#           successCondition: result == "success"
#           timeout: {{ .Values.analysis.webhook.timeout | default "5m" }}
# {{- end }}
